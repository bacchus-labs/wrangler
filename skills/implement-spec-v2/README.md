# implement-spec-v2

Modular specification implementation skill that orchestrates existing wrangler skills.

## Overview

This skill implements specifications end-to-end by coordinating existing skills (writing-plans, implement) rather than reimplementing their logic. It focuses on workflow orchestration, verification gates, and GitHub PR management.

## Architecture

### Modular Design

```
implement-spec-v2 (orchestrator)
├── Phase 1: INIT → Uses session_start MCP tool
├── Phase 2: PLAN → Invokes writing-plans skill
├── Phase 3: EXECUTE → Invokes implement skill
├── Phase 4: VERIFY → LLM-based compliance audit
├── Phase 5: PUBLISH → GitHub PR finalization
└── Phase 6: COMPLETE → Session closure
```

### Benefits

- **No duplication**: Planning logic lives in writing-plans (one place)
- **No duplication**: Implementation logic lives in implement (one place)
- **Maintainability**: Changes to planning/execution update all consumers
- **Testability**: Each skill can be tested independently
- **Composability**: Skills can be invoked standalone or orchestrated

## Dependencies

### Required Skills

- **writing-plans**: Creates MCP issues from specification
- **implement**: Executes issues with TDD and code review
- **test-driven-development**: TDD workflow enforced by implement
- **requesting-code-review**: Code review framework used by implement

### Required Tools

- **session_start**: MCP tool for worktree initialization
- **session_phase**: MCP tool for phase tracking
- **session_checkpoint**: MCP tool for recovery
- **session_complete**: MCP tool for finalization
- **issues_create**: MCP tool for issue creation (via writing-plans)
- **issues_list**: MCP tool for issue querying

## Workflow Phases

### Phase 1: INIT

- Calls `session_start` MCP tool to create worktree
- Verifies worktree location and branch
- Establishes session context

### Phase 2: PLAN

- Dispatches planning subagent with specification
- Subagent invokes `writing-plans` skill
- writing-plans creates MCP issues (source of truth)
- Optional plan file created for architecture context
- Creates GitHub PR with overview (not full plan)

**Key insight**: Individual issues are generated by writing-plans calling `issues_create` for each task with complete implementation details (files, code, tests, commands).

### Phase 3: EXECUTE

- Invokes `implement` skill with issue IDs
- implement dispatches subagent per issue
- Each subagent follows TDD (RED-GREEN-REFACTOR)
- Automatic code review after each issue
- Auto-fix for Critical/Important issues
- Only stops for genuine blockers

**Key insight**: All execution logic lives in implement skill. We just invoke it with our session context.

### Phase 4: VERIFY

- LLM reads spec and extracts acceptance criteria
- Verifies each criterion has evidence (tests, code, commits)
- Runs fresh test suite
- Checks git status (must be clean)
- Calculates compliance percentage
- **BLOCKS if compliance < 100%**

**Key insight**: LLM-based extraction handles varied spec formats gracefully (not brittle regex parsing).

### Phase 5: PUBLISH

- Updates PR description with final summary
- Lists all tasks with commit hashes
- Shows test results and compliance
- Marks PR ready for review
- Adds reviewers if configured

### Phase 6: COMPLETE

- Calls `session_complete` MCP tool
- Records PR URL, session ID, metrics
- Presents completion summary
- Provides audit trail location

## Quality Gates

| Phase | Gate | Required |
|-------|------|----------|
| INIT | Worktree created | Yes |
| PLAN | Issues created | Yes |
| EXECUTE | All tasks complete | Yes |
| VERIFY | 100% compliance | Yes |
| VERIFY | All tests passing | Yes |
| VERIFY | Git clean | Yes |
| PUBLISH | PR ready | Yes |

**VERIFY phase is mandatory and cannot be skipped.**

## Usage

### Via Slash Command

```
/wrangler:implement-v2 SPEC-000042
```

### Manual Invocation

```markdown
I'm using the implement-spec-v2 skill to implement SPEC-000042.md
```

See `SKILL.md` for detailed workflow documentation.

## Examples

See `examples/` directory:
- `simple-feature.md` - Backend feature (no E2E)
- `complex-feature.md` - User-facing feature (with E2E)
- `recovery.md` - Session recovery after interruption

## Scripts

### generate-pr-description.sh

Generates PR description from template and session data.

**Usage:**
```bash
./scripts/generate-pr-description.sh <phase> <session-data>
```

**Phases:**
- planning: Initial PR creation
- execution: Progress updates
- verification: Quality gate results
- complete: Final summary

### update-pr-description.sh

Updates GitHub PR description via gh CLI with sanitization.

**Usage:**
```bash
./scripts/update-pr-description.sh <prNumber> <newDescription>
```

**Features:**
- Sanitizes sensitive data (tokens, credentials)
- Validates PR exists before update
- Error handling for gh CLI failures

### Removed Scripts

- `analyze-spec.sh` - Removed (replaced with LLM-based extraction)
- `audit-spec-compliance.sh` - Removed (integrated into VERIFY phase)
- `orchestrator.sh` - Removed (logic now in SKILL.md)

**Why removed**: Brittle regex parsing that breaks with spec format variations. LLM-based extraction is more robust and intelligent.

## Testing

No tests currently (orchestration skill, not implementation).

Future testing considerations:
- Mock skill invocations
- Test phase transitions
- Test quality gate logic
- Test recovery scenarios

## Integration with Wrangler

This skill is part of the wrangler skills library and follows wrangler patterns:

- Uses MCP tools for session management
- Invokes existing skills (no duplication)
- Follows TDD enforcement via implement skill
- Uses GitHub PR as primary audit trail
- Supports worktree isolation
- Provides recovery capability via checkpoints

## Comparison with implement-spec (v1)

**implement-spec (v1):**
- Assumes MCP issues already exist
- Goes straight to execution (INIT → PLAN → EXECUTE → VERIFY → PUBLISH)
- Uses `implement` skill for execution
- Best for: Implementing existing issues

**implement-spec-v2 (this skill):**
- Starts from specification file
- Adds PLAN phase (invokes writing-plans)
- Adds mandatory VERIFY phase (compliance audit)
- Uses `implement` skill for execution
- Best for: Implementing specs end-to-end

**When to use which:**
- Use `implement-spec` if you have MCP issues already
- Use `implement-spec-v2` if starting from specification

## File Structure

```
implement-spec-v2/
├── SKILL.md                    # Detailed workflow documentation
├── README.md                   # This file (architecture overview)
├── examples/                   # Usage examples
│   ├── simple-feature.md       # Backend feature example
│   ├── complex-feature.md      # UI feature with E2E
│   └── recovery.md             # Session recovery example
├── scripts/                    # Helper scripts
│   ├── generate-pr-description.sh
│   ├── update-pr-description.sh
│   └── utils/                  # Shared utilities
└── templates/                  # PR description templates
    ├── planning.md
    ├── execution.md
    ├── verification.md
    └── complete.md
```

## Contributing

When modifying this skill:

1. **Planning changes**: Update `writing-plans` skill (not here)
2. **Implementation changes**: Update `implement` skill (not here)
3. **Orchestration changes**: Update `SKILL.md` (here)
4. **Verification changes**: Update VERIFY phase logic (here)
5. **PR management changes**: Update scripts or templates (here)

**Keep orchestration logic separate from implementation logic.**

## Related Documentation

- [SKILL.md](SKILL.md) - Detailed workflow documentation
- [commands/implement-v2.md](../../commands/implement-v2.md) - Slash command documentation
- [skills/writing-plans/SKILL.md](../writing-plans/SKILL.md) - Planning skill
- [skills/implement/SKILL.md](../implement/SKILL.md) - Implementation skill
- [docs/MCP-USAGE.md](../../docs/MCP-USAGE.md) - MCP tools reference

## Version History

- **v2.0.0** (2025-02-02): Modular architecture refactor
  - Removed brittle spec parsing scripts
  - Changed to skill orchestration pattern
  - Added LLM-based verification
  - Added mandatory VERIFY phase
  - Improved recovery capability

- **v1.0.0** (initial): GitHub-centric workflow (deprecated)

## License

MIT (part of wrangler project)
